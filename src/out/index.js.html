<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable semi */
/* eslint-disable space-before-function-paren */
/* eslint-disable indent */
const session = require('./lib/session')
const query = require('./lib/ldflex-queries')
const Chat = require('./lib/chat')
const Person = require('./model/person')

let user;

/**
 * On DOM load, set solid.auth to track the session status
 */
$('document').ready(async () => {
    session.track(
        // If there's a session
        async () => {
            user = await session.getUser();
            console.log(user)
            changeView(true)
        },
        // User isn't logged in
        async () => {
            user = null;
            console.log(user)
            changeView(false)
        }
    )
})

// Button listeners
$('#login').click(async () => {
    session.login()
})

$('#logout').click(async () => {
    session.logout()
    $('.friends-list').css('border', '1px solid #2FA7F5');
})


/**
* Send a message
* @param {Chat} the chat to which it will be sent
* @param {Integer} i
*/
function sendMessage(chat, i) {
    chat.sendMessage(document.getElementById('messageText' + i).value);
    document.getElementById('messageText' + i).value = '';
}

var numberMessagesSended;

/**
* Start a chat with the selected friend
* @param {Person} object representing the user's contact
* @param {Integer} i
*/
async function startChat(friend, i) {
    var splitId = user.id.split('/');
    var urlFolder = splitId[0] + splitId[1] + splitId[2];
    const chat = new Chat(user, friend)
    chat.checkDechatFolder(urlFolder);
    //We start the chat when we make sure we have the folder created.
    console.log('Chat with ' + friend.id + ' opened')
    $('.friends-list').prepend("&lt;div class='chatContainer' id='chatContainer" + i + "'>" + '&lt;h4>' + friend.name + "&lt;/h4>&lt;div class='chatContent' id='chatContent" + i + "'>&lt;p id='textMessageScreen' class='textMessageScreen'>Welcome!\n&lt;/p>&lt;/div>" + "&lt;div id='sendMessage'" + i + "'>" + "&lt;textarea rows='2' cols='34' id='messageText" + i + "'>" + "Send a message&lt;/textarea>&lt;button class='sendButton' id='messageFriend" + i + "'>Send&lt;/button>&lt;/div>&lt;/div>");
    $('#buttonFriend' + i).prop('disabled', true);
    $('#messageFriend' + i).click(async () => {
        sendMessage(chat, i)
        //it may be a solve to show messages when they are send but it produces other bugs.
        $('.chatContent').append("&lt;p class='textMessageSended'>" + user.inbox.substring(0, user.inbox.length - 6) + ' >' + document.getElementById('messageText' + i).value + '&lt;/p>');
        numberMessagesSended++;
    });

    // Set up listener for new messages, time in ms
    setInterval(() => {
        checkForNewMessages(chat)
    }, 5000)
}

/**
* Empty the user's contacts html list
*/
function emptyFriendsList() {
    $('.friends-list').empty()
}

$('#friends').click(async () => {
    $('.friends-list').show();
    $('.friends-list').css('border', '1px solid #2FA7F5');
    userWerbId = session.getSession().webId;
    friends = await query.getFriends();
    emptyFriendsList();
    $.each(friends, (i, friend) => {
        console.log(friend, i)
        $('.friends-list').prepend("&lt;ul>&lt;button class='contactButton' id='buttonFriend" + i + "'>" + 'Chat with ' + friend.name + '&lt;/button>&lt;/ul>');
        $('#buttonFriend' + i).click(async () => { startChat(friend, i) });

        console.log('Friend #' + i + ' ' + friend.id + ' ' + friend.name + ' ' + friend.inbox);
    })
    $('.friends-list').prepend("&lt;ul>&lt;button class='closeChats' id='closeChats'>" + 'Close Chats &lt;/button>&lt;/ul>');
    $('#closeChats').click(async () => { closeChats(friends) });
})

/**
* Close the chats of the friends list
* @param {List&lt;Person>} list of the user's contacts
*/
function closeChats(friends) {
    $.each(friends, (i, friend) => {
        $('#chatContainer' + i).remove()
        $('#buttonFriend' + i).prop('disabled', false);
    })
}

/**
 * Sets the buttons, nav and titles according to the session status.
 * If we initiate session we hide the button of the log and appears the nav and the button of the list of friends.
 * If we close session disappears the nav and the button of the list of friends and the button of the login appears.
 * Change the titles depending on whether we are logged in or not.
 * If we are not logged in, we will empty the list of friends.
 * @param {boolean} session 
 */
function changeView(session) {

    $('#login').prop('hidden', session);
    $('#login').prop('show', !session);
    $('#friends').prop('hidden', !session);
    $('#friends').prop('show', session);
    changeTitles(session);
    if (!session)
        $('#navbar').css('visibility', 'hidden');
    if (session)
        $('#navbar').css('visibility', 'visible');
    if (!session)
        emptyFriendsList()
}

/**
* Change titles depending on whether they have logged in or not.
* @param {boolean} session
*/
async function changeTitles(session) {
    if (session) {
        $('#titleApp').html('Welcome user: ' + await query.getName());
        $('#subTitleApp').prop('hidden', session)
    } else {
        $('#titleApp').html('Sign in using Solid technology');
        $('#subTitleApp').prop('show', session)
    }
}


/**
* Check if there is a new message in a chat.
* @param {Chat} A chat in particular
*/
async function checkForNewMessages(chat) {
    // Pass the callback function to execute if a new notification is received
    var messages = await chat.checkForNotifications((messages) => { showNotification(chat); updateUIMessages(messages) });
}

/**
* Update chat UI. This function should only be called once a notification has arrived.
* @param {Message[]} messages Message array containing chat messages
*/
function updateUIMessages(messages) {
	// Deleted all the displayed messages
    $('#textMessageScreen').remove();
    $('.textMessageScreen').remove();
    var i;
    //Show all the messages
    var j;
    var messageSendedContent;
    for (j = 0; j &lt; numberMessagesSended; j++)
        messageSendedContent[j] = $('.textMessageSended').text();


    for (i = 0; i &lt; messages.length; i++) {
        $('.chatContent').append("&lt;p class='textMessageScreen' id='textMessageScreen'>" + messages[i].sender + ' >' + messages[i].content + '&lt;/p>');
    }

    $('.textMessageSended').remove();
    var k;
    for (k = 0; k &lt; numberMessagesSended; k++)
        $('.chatContent').append("&lt;p class='textMessageSended'>" + messageContent[k] + '&lt;/p>');
}

/**
 * Shows a notification in screen when it arrives.
 * @param {Chat} A chat in particular
 */
async function showNotification(chat) {
    console.log('Got a new message');
    $('.friends-list').prepend("&lt;div id='notificacion' class='alert alert-info'>" + chat.partner.name + ' sends you a new message!&lt;/div>');
    hideNotifications();
}

/**
 * This method has the function of hiding notifications
 */
async function hideNotifications() {
    $('#notificacion').fadeOut(1500);
}


</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#changeTitles">changeTitles</a></li><li><a href="global.html#changeView">changeView</a></li><li><a href="global.html#checkForNewMessages">checkForNewMessages</a></li><li><a href="global.html#closeChats">closeChats</a></li><li><a href="global.html#emptyFriendsList">emptyFriendsList</a></li><li><a href="global.html#hideNotifications">hideNotifications</a></li><li><a href="global.html#sendMessage">sendMessage</a></li><li><a href="global.html#showNotification">showNotification</a></li><li><a href="global.html#startChat">startChat</a></li><li><a href="global.html#updateUIMessages">updateUIMessages</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Mar 24 2019 19:26:51 GMT+0100 (GMT+01:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
